<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Giveaway Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0c10; --panel:#111317; --panel-2:#151820; --text:#e8ecf1;
      --muted:#aab3c0; --brand:#6aa6ff; --brand-2:#3d86ff; --ok:#22c55e;
      --warn:#f59e0b; --danger:#ef4444; --border:#1e2230; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fb; --panel:#fff; --panel-2:#fff; --text:#101318; --muted:#5c6470; --brand:#3d86ff; --brand-2:#2d6df0; --ok:#16a34a; --warn:#d97706; --danger:#ef4444; --border:#e6eaf1; --shadow:0 6px 20px rgba(12,14,20,.08); }
    }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      background:radial-gradient(1600px 800px at 0% 0%, #0f1220 0%, transparent 60%), var(--bg);
    }
    .container{ max-width:1100px; margin:0 auto; padding:20px }
    header{ display:flex; gap:14px; align-items:center; margin-bottom:16px }
    .logo{
      width:38px; height:38px; border-radius:10px; display:grid; place-items:center;
      background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; font-weight:700; box-shadow:var(--shadow)
    }
    .pill{ padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:var(--panel); color:var(--muted) }
    .pill.live{ color:#0f0; border-color:#0f0 }
    .grid{ display:grid; gap:16px; grid-template-columns:1.1fr .9fr }
    @media(max-width:960px){ .grid{ grid-template-columns:1fr } }

    .card{ background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow) }
    .card .hd{ padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px }
    .card .bd{ padding:16px }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }

    input{
      height:36px; padding:0 10px; border-radius:10px; border:1px solid var(--border);
      background:#0b111c; color:var(--text)
    }
    @media(prefers-color-scheme:light){ input{ background:#fff } }

    /* DEFAULT BUTTONS = GRAY */
    .btn{
      height:36px; padding:0 14px; border-radius:10px;
      border:1px solid var(--border);
      background:#e2e8f0;
      color:#111;
      cursor:pointer; transition:.15s;
    }
    .btn:hover{ background:#d0d7e1 }
    .btn:active{ transform: translateY(1px) }

    /* VARIANTS */
    .btn.primary{ background:linear-gradient(180deg,var(--brand),var(--brand-2)); border-color:transparent; color:#fff }
    .btn.ok{ background:linear-gradient(180deg,#22c55e,#16a34a); border-color:transparent; color:#04130a }
    .btn.warn{ background:linear-gradient(180deg,#f59e0b,#d97706); border-color:transparent; color:#1f1300 }
    .btn.danger{ background:linear-gradient(180deg,#ff6b6b,#ef4444); border-color:transparent; color:#2a0000 }

    .kpi{ display:flex; gap:14px; flex-wrap:wrap }
    .kpi .chip{ background:#0b111c; border:1px solid var(--border); padding:8px 12px; border-radius:10px; font-size:13px }
    @media(prefers-color-scheme:light){ .kpi .chip{ background:#fff } }
    .last-updated{ font-size:12px; color:var(--muted); margin-top:6px }

    .scroll{
      border:1px solid var(--border); border-radius:10px; background:#0b111c; height:52vh; overflow:auto; padding:10px
    }
    @media(prefers-color-scheme:light){ .scroll{ background:#fff } }
    .badge{ padding:4px 8px; border-radius:8px; font-size:12px; border:1px solid var(--border); background:#0b111c }
    .toast{
      position:fixed; right:18px; bottom:18px; padding:10px 12px; border-radius:10px;
      background:#0b111c; border:1px solid var(--border); color:var(--text);
      box-shadow:var(--shadow); opacity:0; transform:translateY(8px); transition:.2s
    }
    .toast.show{ opacity:1; transform:translateY(0) }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">GW</div>
      <div>
        <h2 style="margin:0">Giveaway Dashboard</h2>
        <div style="color:var(--muted); font-size:13px">Start, close, roll, and confirm winners ‚Äî logs to Google Sheets</div>
      </div>
      <div style="margin-left:auto" id="livepill" class="pill">disconnected</div>
    </header>

    <div class="card">
      <div class="hd"><strong>Controls</strong></div>
      <div class="bd">
        <div class="row" style="margin-bottom:10px">
          <label>Keyword <input id="kw" value="yo" style="width:120px; margin-left:6px"></label>
          <label>Admin Token 
            <input type="password" id="token" placeholder="optional" style="width:220px; margin-left:6px">
          </label>
          <button class="btn primary" onclick="start()">Start</button>
          <button class="btn danger" onclick="closeGiveaway()">Close</button>
          <button class="btn warn" onclick="roll()">Roll</button>
          <button class="btn ok" onclick="confirmWinner()">Confirm</button>
          <button class="btn warn" onclick="reroll()">Reroll</button>
          <button class="btn ok" onclick="cancel()">Cancel</button>
        </div>
        <div class="kpi">
          <div class="chip">Open: <b id="kOpen">false</b></div>
          <div class="chip">Keyword: <b id="kKw">yo</b></div>
          <div class="chip">Entrants: <b id="kCnt">0</b></div>
          <div class="chip">Pending Winner: <b id="kPending">‚Äî</b></div>
          <div class="chip">Total Given (session): $<b id="kTotal">0</b></div>
        </div>
        <div id="lastUpdated" class="last-updated">Last updated: ‚Äî</div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <div class="hd" style="display:flex;justify-content:space-between">
          <strong>Entrants</strong>
          <div class="row">
            <input id="search" placeholder="Filter entrants‚Ä¶" style="width:220px">
            <button class="btn" id="copyBtn">Copy</button>
          </div>
        </div>
        <div class="bd">
          <div class="scroll"><div id="entrants">‚Äî</div></div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><strong>Status</strong></div>
        <div class="bd">
          <div id="status">‚Äî</div>
          <div style="height:12px"></div>

          <!-- Pending winner card -->
          <div id="pendingInner" class="card" style="border:1px dashed var(--border); background:transparent;">
            <div class="bd">No pending winner‚Ä¶</div>
          </div>

          <!-- NEW: Pending user's recent chat -->
          <div id="pendingChat" class="card" style="margin-top:10px; border:1px dashed var(--border); background:transparent;">
            <div class="bd">
              <div style="color:var(--muted); font-size:13px; margin-bottom:6px">
                Recent chat from pending winner:
                <span id="pendingChatHint" style="margin-left:6px; opacity:.8"></span>
              </div>
              <div id="pendingChatList" class="scroll" style="height:160px;"></div>
            </div>
          </div>

          <div style="height:12px"></div>
          <div>
            <div style="color:var(--muted); font-size:13px">Recent winners:</div>
            <div id="recent" class="row" style="margin-top:6px; flex-wrap:wrap"></div>
          </div>
          <div style="height:12px"></div>
          <div class="row">
            <label>Amount <input id="amount" value="5" style="width:100px; margin-left:6px"></label>
            <label>Note <input id="note" placeholder="Daily / Sponsor" style="width:220px; margin-left:6px"></label>
          </div>
        </div>
      </div>
    </div>

    <div id="toast" class="toast">Saved</div>
  </div>

<script>
const API = location.origin.replace(/\/$/,''); 
let _allEntrants = [];
let _lastStatus = null;

/* ---------------- Session Total (client-only) ---------------- */
const SESSION_KEY = 'gw.sessionTotal.v1';
function loadSession(){
  try{
    const s = JSON.parse(sessionStorage.getItem(SESSION_KEY));
    if (!s || typeof s.total !== 'number' || !Array.isArray(s.ids)) return { total: 0, ids: [] };
    return s;
  }catch{ return { total: 0, ids: [] }; }
}
function saveSession(s){ sessionStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
let _session = loadSession();

function fmtCurrency(n){
  return new Intl.NumberFormat(undefined, { style:'currency', currency:'USD' }).format(n||0);
}
function updateTotalUI(){
  document.getElementById('kTotal').textContent = _session.total.toFixed(2).replace(/\.00$/,'');
  document.getElementById('lastUpdated').textContent = 'Last updated: ' +
    new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
}
function bumpSessionTotal(amount, dedupeId){
  const amt = Number(amount);
  if (!Number.isFinite(amt)) return { ok:false, error:'Invalid amount' };
  if (dedupeId && _session.ids.includes(String(dedupeId))){
    updateTotalUI();
    return { ok:true, deduped:true, total:_session.total };
  }
  _session.total = (_session.total || 0) + amt;
  if (dedupeId) _session.ids.push(String(dedupeId));
  saveSession(_session);
  updateTotalUI();
  return { ok:true, total:_session.total };
}
/* ------------------------------------------------------------ */

function authHeaders() {
  const t = document.getElementById('token').value.trim();
  return t ? { 'x-admin-token': t, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
}

async function start(){
  const keyword = document.getElementById('kw').value || 'yo';
  await fetch(API + '/start', { method:'POST', headers:authHeaders(),
    body: JSON.stringify({ keyword }) });
  toast('Giveaway started'); refresh();
}

async function closeGiveaway(){
  const r = await fetch(API + '/close', { method:'POST', headers:authHeaders() });
  if (!r.ok) toast('No giveaway open', true);
  else toast('Giveaway closed');
  refresh();
}

async function roll() {
  try {
    const r = await fetch(API + '/roll', { method: 'POST', headers: authHeaders() });
    if (!r.ok) { toast('Cannot roll yet', true); return; }
    const data = await r.json();
    toast('Rolled');
    if (data.pendingWinner) {
      _lastStatus.pendingWinner = data.pendingWinner;
      renderPending(data.pendingWinner);
      refreshPendingChat(true); // immediate fetch for new pending
    }
    refresh();
  } catch (err) {
    toast('Roll failed', true);
  }
}

async function confirmWinner(){
  const amt = document.getElementById('amount').value || '';
  const note = document.getElementById('note').value || '';
  const manual = prompt('Confirm which winner? (leave blank to confirm the pending one)');
  const r = await fetch(API + '/confirm', { method:'POST', headers:authHeaders(),
    body: JSON.stringify({ winner: manual || undefined, amount: amt, note }) });
  if (!r.ok){
    toast('No winner to confirm', true);
    return refresh();
  }
  toast('Winner confirmed üéâ');

  // --- Session total bump (client-only) ---
  const pending = _lastStatus?.pendingWinner;
  const dedupeId = manual || (pending?.gid ?? pending?.user ?? '');
  const bump = bumpSessionTotal(amt, dedupeId);
  if (bump.deduped) toast('Already counted this session', true);

  refresh();
}

async function reroll() {
  try {
    const r = await fetch(API + '/reroll', { method: 'POST', headers: authHeaders() });
    if (!r.ok) { toast('No entrants', true); return; }
    const data = await r.json();
    toast('Rerolled');
    if (data.pendingWinner) {
      _lastStatus.pendingWinner = data.pendingWinner;
      renderPending(data.pendingWinner);
      refreshPendingChat(true); // immediate fetch
    }
    refresh();
  } catch (err) {
    toast('Reroll failed', true);
  }
}

async function cancel(){ await fetch(API + '/cancel', { method:'POST', headers:authHeaders() }); toast('Pending cleared'); refresh(); }

function toast(msg, isErr=false){ const el = document.getElementById('toast'); el.textContent = msg; el.style.borderColor = isErr ? 'var(--danger)' : 'var(--border)'; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1800); }

function renderEntrants(){
  const q = (document.getElementById('search').value || '').trim().toLowerCase();
  const filtered = q ? _allEntrants.filter(u => u.toLowerCase().includes(q)) : _allEntrants;

  const html = filtered.length ? filtered.map(u => `
    <div class="row" style="justify-content:space-between; padding:4px 0; border-bottom:1px dashed var(--border);">
      <div>@${u}</div>
      <div class="row">
        <button class="btn" onclick="openViewerCard('${encodeURIComponent(u)}')">User card</button>
      </div>
    </div>`).join('') : '‚Äî';

  document.getElementById('entrants').innerHTML = html;
  document.getElementById('kCnt').textContent = filtered.length;
}

function renderRecent(list){
  const wrap = document.getElementById('recent'); wrap.innerHTML = '';
  (list || []).slice(0,10).forEach(w => {
    const d = document.createElement('div'); d.className = 'badge';
    const dt = new Date(w.at || Date.now());
    d.textContent = `${w.winner} ‚Ä¢ ${dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    wrap.appendChild(d);
  });
}

function viewerCardUrl(channel, username) {
  const ch = (_lastStatus?.channel || '').replace(/^#/, '');
  return `https://www.twitch.tv/popout/${encodeURIComponent(ch)}/viewercard/${encodeURIComponent(username)}`;
}

function openViewerCard(username) {
  const decoded = decodeURIComponent(username);
  window.open(viewerCardUrl(_lastStatus?.channel, decoded), '_blank', 'noopener,width=420,height=640');
}

function openPendingUserCard() {
  const user = _lastStatus?.pendingWinner?.user;
  if (!user) return alert('No pending winner right now.');
  openViewerCard(user);
}

function renderPending(pending){
  const box = document.getElementById('pendingInner');
  if (!pending){ 
    box.innerHTML = '<div class="bd" style="color:var(--muted)">No pending winner‚Ä¶</div>'; 
    // clear chat panel too
    renderPendingChat([]);
    document.getElementById('pendingChatHint').textContent = '';
    return; 
  }
  box.innerHTML = `
    <div class="bd">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:600; font-size:16px">@${pending.user}</div>
          <div style="color:var(--muted); font-size:12px">GID: ${pending.gid}</div>
        </div>
        <div class="row">
          <button class="btn" onclick="openPendingUserCard()">User card</button>
          <button class="btn ok" onclick="confirmWinner()">Confirm</button>
          <button class="btn warn" onclick="reroll()">Reroll</button>
          <button class="btn ok" onclick="cancel()">Cancel</button>
        </div>
      </div>
    </div>`;
}

/* ---------------- Pending chat view ---------------- */
function escapeHtml(s){
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

function renderPendingChat(lines){
  const list = document.getElementById('pendingChatList');
  if (!list) return;
  if (!lines || !lines.length){
    list.innerHTML = '<div style="color:var(--muted)">No messages yet‚Ä¶</div>';
    return;
  }
  list.innerHTML = lines.map(m => {
    const t = new Date(m.at);
    const hhmm = t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    return `<div style="padding:4px 0; border-bottom:1px dashed var(--border)">
      <span style="opacity:.7; font-size:12px">${hhmm}</span>
      <span style="opacity:.7"> ‚Ä¢ </span>
      <span>${escapeHtml(m.text)}</span>
    </div>`;
  }).join('');
}

async function refreshPendingChat(force=false){
  const user = _lastStatus?.pendingWinner?.user;
  const since = _lastStatus?.pendingSince;
  const hint = document.getElementById('pendingChatHint');
  if (!user){
    renderPendingChat([]);
    if (hint) hint.textContent = '';
    return;
  }
  // tiny optimization: only show ‚Äúsince‚Äù if available
  if (hint) hint.textContent = since ? `since ${new Date(since).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` : '';

  try{
    const url = new URL(API + '/user-messages', location.origin);
    url.searchParams.set('user', user);
    if (since) url.searchParams.set('since', String(since));
    const r = await fetch(url.toString());
    const data = await r.json();
    if (data.ok) renderPendingChat(data.messages || []);
  }catch(e){
    // ignore errors, keep panel quiet
  }
}
/* --------------------------------------------------- */

async function refresh(){
  try{
    const r = await fetch(API + '/status');
    const s = await r.json(); _lastStatus = s;
    document.getElementById('livepill').textContent = 'connected';
    document.getElementById('livepill').classList.add('live');
    document.getElementById('kOpen').textContent = s.open;
    document.getElementById('kKw').textContent = s.keyword;
    document.getElementById('kPending').textContent = s.pendingWinner ? '@'+s.pendingWinner.user : '‚Äî';
    document.getElementById('status').innerHTML = `Open: <b>${s.open}</b> ‚Ä¢ Keyword: <b>${s.keyword}</b>`;
    _allEntrants = s.entrants || [];

    // üîÅ Session-only total: update UI from local session (no server call)
    updateTotalUI();

    renderEntrants(); renderPending(s.pendingWinner); renderRecent(s.history);

    // üîé Pending chat polling
    refreshPendingChat();
  } catch(e){
    const lp = document.getElementById('livepill'); 
    lp.textContent = 'disconnected'; 
    lp.classList.remove('live');
  }
}

document.getElementById('search').addEventListener('input', renderEntrants);
document.getElementById('copyBtn').addEventListener('click', async () => {
  try { await navigator.clipboard.writeText((_allEntrants||[]).join('\n')); toast('Entrants copied'); }
  catch(e){ toast('Copy failed', true); }
});

// Poll status (and pending chat) every 1.5s
setInterval(refresh, 1500); 
refresh();

// ‚úÖ Attach functions to window for onclick buttons
window.start = start;
window.closeGiveaway = closeGiveaway;
window.roll = roll;
window.confirmWinner = confirmWinner;
window.reroll = reroll;
window.cancel = cancel;
</script>
</body>
</html>
