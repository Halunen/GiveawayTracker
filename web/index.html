<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Giveaway Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0c10; --panel:#111317; --panel-2:#151820; --text:#e8ecf1;
      --muted:#aab3c0; --brand:#6aa6ff; --brand-2:#3d86ff; --ok:#22c55e;
      --warn:#f59e0b; --danger:#ef4444; --border:#1e2230; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f8fb; --panel:#fff; --panel-2:#fff; --text:#101318; --muted:#5c6470; --brand:#3d86ff; --brand-2:#2d6df0; --ok:#16a34a; --warn:#d97706; --danger:#ef4444; --border:#e6eaf1; --shadow:0 6px 20px rgba(12,14,20,.08); }
    }
    *{ box-sizing:border-box }
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--text);
      background:radial-gradient(1600px 800px at 0% 0%, #0f1220 0%, transparent 60%), var(--bg);
    }
    .container{ max-width:1100px; margin:0 auto; padding:20px }
    header{ display:flex; gap:14px; align-items:center; margin-bottom:16px }
    .logo{
      width:38px; height:38px; border-radius:10px; display:grid; place-items:center;
      background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; font-weight:700; box-shadow:var(--shadow)
    }
    .pill{ padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:var(--panel); color:var(--muted) }
    .pill.live{ color:#0f0; border-color:#0f0 }
    .grid{ display:grid; gap:16px; grid-template-columns:1.1fr .9fr }
    @media(max-width:960px){ .grid{ grid-template-columns:1fr } }

    .card{ background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow) }
    .card .hd{ padding:14px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px }
    .card .bd{ padding:16px }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }

    input{
      height:36px; padding:0 10px; border-radius:10px; border:1px solid var(--border);
      background:#0f1320; color:var(--text)
    }
    @media(prefers-color-scheme:light){ input{ background:#fff } }

    /* DEFAULT BUTTONS = GRAY (not black) */
    .btn{
      height:36px; padding:0 14px; border-radius:10px;
      border:1px solid var(--border);
      background:#e2e8f0;      /* light gray */
      color:#111;               /* dark text for contrast */
      cursor:pointer; transition:.15s;
    }
    .btn:hover{ background:#d0d7e1 }
    .btn:active{ transform: translateY(1px) }

    /* VARIANTS */
    .btn.primary{ background:linear-gradient(180deg,var(--brand),var(--brand-2)); border-color:transparent; color:#fff }
    .btn.ok{ background:linear-gradient(180deg,#22c55e,#16a34a); border-color:transparent; color:#04130a } /* green */
    .btn.warn{ background:linear-gradient(180deg,#f59e0b,#d97706); border-color:transparent; color:#1f1300 } /* yellow/orange */
    .btn.danger{ background:linear-gradient(180deg,#ff6b6b,#ef4444); border-color:transparent; color:#2a0000 } /* red (unused for cancel per request) */

    .kpi{ display:flex; gap:14px; flex-wrap:wrap }
    .kpi .chip{ background:#0f1320; border:1px solid var(--border); padding:8px 12px; border-radius:10px; font-size:13px }
    @media(prefers-color-scheme:light){ .kpi .chip{ background:#fff } }
    .scroll{
      border:1px solid var(--border); border-radius:10px; background:#0f1320; height:52vh; overflow:auto; padding:10px
    }
    @media(prefers-color-scheme:light){ .scroll{ background:#fff } }
    .badge{ padding:4px 8px; border-radius:8px; font-size:12px; border:1px solid var(--border); background:#0f1320 }
    .toast{
      position:fixed; right:18px; bottom:18px; padding:10px 12px; border-radius:10px;
      background:#0b111c; border:1px solid var(--border); color:var(--text);
      box-shadow:var(--shadow); opacity:0; transform:translateY(8px); transition:.2s
    }
    .toast.show{ opacity:1; transform:translateY(0) }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">GW</div>
      <div>
        <h2 style="margin:0">Giveaway Dashboard</h2>
        <div style="color:var(--muted); font-size:13px">Start, roll, and confirm winners â€” logs to Google Sheets</div>
      </div>
      <div style="margin-left:auto" id="livepill" class="pill">disconnected</div>
    </header>

    <div class="card">
      <div class="hd"><strong>Controls</strong></div>
      <div class="bd">
        <div class="row" style="margin-bottom:10px">
          <label>Keyword <input id="kw" value="yo" style="width:120px; margin-left:6px"></label>
          <label>Open (sec) <input id="secs" value="60" style="width:120px; margin-left:6px"></label>
          <label>Admin Token <input id="token" placeholder="optional" style="width:220px; margin-left:6px"></label>
          <button class="btn primary" onclick="start()">Start</button>
          <button class="btn warn" onclick="roll()">Roll</button>          <!-- yellow -->
          <button class="btn ok" onclick="confirmWinner()">Confirm</button> <!-- green -->
          <button class="btn warn" onclick="reroll()">Reroll</button>       <!-- yellow (kept as warn) -->
          <button class="btn ok" onclick="cancel()">Cancel</button>         <!-- green per request -->
          <button class="btn" onclick="openPendingUserCard()">User card</button>
        </div>
        <div class="kpi">
          <div class="chip">Open: <b id="kOpen">false</b></div>
          <div class="chip">Keyword: <b id="kKw">yo</b></div>
          <div class="chip">Entrants: <b id="kCnt">0</b></div>
          <div class="chip">Pending Winner: <b id="kPending">â€”</b></div>
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <div class="hd" style="display:flex;justify-content:space-between">
          <strong>Entrants</strong>
          <div class="row">
            <input id="search" placeholder="Filter entrantsâ€¦" style="width:220px">
            <button class="btn" id="copyBtn">Copy</button>
          </div>
        </div>
        <div class="bd">
          <div class="scroll"><div id="entrants">â€”</div></div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><strong>Status</strong></div>
        <div class="bd">
          <div id="status">â€”</div>
          <div style="height:12px"></div>
          <div id="pendingInner" class="card" style="border:1px dashed var(--border); background:transparent;">
            <div class="bd">No pending winnerâ€¦</div>
          </div>
          <div style="height:12px"></div>
          <div>
            <div style="color:var(--muted); font-size:13px">Recent winners:</div>
            <div id="recent" class="row" style="margin-top:6px; flex-wrap:wrap"></div>
          </div>
          <div style="height:12px"></div>
          <div class="row">
            <label>Amount <input id="amount" value="5" style="width:100px; margin-left:6px"></label>
            <label>Note <input id="note" placeholder="Daily / Sponsor" style="width:220px; margin-left:6px"></label>
          </div>
        </div>
      </div>
    </div>

    <div id="toast" class="toast">Saved</div>
  </div>

<script>
const API = location.origin.replace(/\/$/,''); 
let _allEntrants = [];
let _lastStatus = null;

function authHeaders() {
  const t = document.getElementById('token').value.trim();
  return t ? { 'x-admin-token': t, 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
}
function viewerCardUrl(channel, username) {
  const ch = (channel || '').replace(/^#/, '');
  return `https://www.twitch.tv/popout/${encodeURIComponent(ch)}/viewercard/${encodeURIComponent(username)}`;
}
function openViewerCard(username) {
  const ch = _lastStatus?.channel || '';
  window.open(viewerCardUrl(ch, username), '_blank', 'noopener,width=420,height=640');
}
function openPendingUserCard() {
  const user = _lastStatus?.pendingWinner?.user;
  if (!user) return alert('No pending winner right now.');
  openViewerCard(user);
}

async function start(){
  const keyword = document.getElementById('kw').value || 'yo';
  const secs = Number(document.getElementById('secs').value || 60);
  await fetch(API + '/start', { method:'POST', headers:authHeaders(),
    body: JSON.stringify({ keyword, durationMs: secs*1000 }) });
  toast('Giveaway started'); refresh();
}
async function roll(){ const r = await fetch(API + '/roll', { method:'POST', headers:authHeaders() }); if (!r.ok) toast('Cannot roll yet', true); else toast('Rolled'); refresh(); }
async function confirmWinner(){
  const amt = document.getElementById('amount').value || '';
  const note = document.getElementById('note').value || '';
  const manual = prompt('Confirm which winner? (leave blank to confirm the pending one)');
  const r = await fetch(API + '/confirm', { method:'POST', headers:authHeaders(),
    body: JSON.stringify({ winner: manual || undefined, amount: amt, note }) });
  if (!r.ok) toast('No winner to confirm', true); else toast('Winner confirmed ðŸŽ‰');
  refresh();
}
async function reroll(){ const r = await fetch(API + '/reroll', { method:'POST', headers:authHeaders() }); if (!r.ok) toast('No entrants', true); else toast('Rerolled'); refresh(); }
async function cancel(){ await fetch(API + '/cancel', { method:'POST', headers:authHeaders() }); toast('Pending cleared'); refresh(); }

function toast(msg, isErr=false){ const el = document.getElementById('toast'); el.textContent = msg; el.style.borderColor = isErr ? 'var(--danger)' : 'var(--border)'; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1800); }

function renderEntrants(){
  const q = (document.getElementById('search').value || '').trim().toLowerCase();
  const filtered = q ? _allEntrants.filter(u => u.toLowerCase().includes(q)) : _allEntrants;
  const html = filtered.length ? filtered.map(u => `
    <div class="row" style="justify-content:space-between; padding:4px 0; border-bottom:1px dashed var(--border);">
      <div>@${u}</div>
      <div class="row"><button class="btn" onclick="openViewerCard('${u.replace(/'/g,"\\'")}')">User card</button></div>
    </div>`).join('') : 'â€”';
  document.getElementById('entrants').innerHTML = html;
  document.getElementById('kCnt').textContent = filtered.length;
}
function renderRecent(list){
  const wrap = document.getElementById('recent'); wrap.innerHTML = '';
  (list || []).slice(0,10).forEach(w => {
    const d = document.createElement('div'); d.className = 'badge';
    const dt = new Date(w.at || Date.now());
    d.textContent = `${w.winner} â€¢ ${dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
    wrap.appendChild(d);
  });
}
function renderPending(pending){
  const box = document.getElementById('pendingInner');
  if (!pending){ box.innerHTML = '<div class="bd" style="color:var(--muted)">No pending winnerâ€¦</div>'; return; }
  box.innerHTML = `
    <div class="bd">
      <div class="row" style="justify-content:space-between">
        <div>
          <div style="font-weight:600; font-size:16px;">@${pending.user}</div>
          <div style="color:var(--muted); font-size:12px">GID: ${pending.gid}</div>
        </div>
        <div class="row">
          <button class="btn" onclick="openPendingUserCard()">User card</button>
          <button class="btn ok" onclick="confirmWinner()">Confirm</button>
          <button class="btn warn" onclick="reroll()">Reroll</button>
          <button class="btn ok" onclick="cancel()">Cancel</button>
        </div>
      </div>
    </div>`;
}

async function refresh(){
  try{
    const r = await fetch(API + '/status');
    const s = await r.json(); _lastStatus = s;
    document.getElementById('livepill').textContent = 'connected';
    document.getElementById('livepill').classList.add('live');
    document.getElementById('kOpen').textContent = s.open;
    document.getElementById('kKw').textContent = s.keyword;
    document.getElementById('kPending').textContent = s.pendingWinner ? '@'+s.pendingWinner.user : 'â€”';
    document.getElementById('status').innerHTML = `Open: <b>${s.open}</b> â€¢ Keyword: <b>${s.keyword}</b>`;
    _allEntrants = s.entrants || [];
    renderEntrants(); renderPending(s.pendingWinner); renderRecent(s.history);
  } catch(e){
    const lp = document.getElementById('livepill'); lp.textContent = 'disconnected'; lp.classList.remove('live');
  }
}
document.getElementById('search').addEventListener('input', renderEntrants);
document.getElementById('copyBtn').addEventListener('click', async () => {
  try { await navigator.clipboard.writeText((_allEntrants||[]).join('\n')); toast('Entrants copied'); }
  catch(e){ toast('Copy failed', true); }
});
setInterval(refresh, 1500); refresh();
</script>
</body>
</html>
